# Unit2
## IPSec
1. TCP層安全協議: SSL/TLS; 確保應用層安全
2. IP層協議: IPsec; 確保TCP以上的安全
3. IP層安全問題
    1. IP頭沒有加密和用戶認證
    2. 源IP欺騙視圖冒充互聯網其他連接
    3. 重放數據包: 雖然TCP層有加密, 但是可以攔截訊息重新發送, 例如重複發送多筆轉帳
4. IPSec目標
    1. 使用hash對數據進行加密
    2. 驗證IP包的完整性
    3. 使用序列號防止舊數據包重放
5. IPSec架構: IPSec由三個協議組成
    1. AH認證頭: 完整性
    2. ESP封裝安全載荷: 加密性
    3. IKE網際網路金鑰交換: IPSec的第一步, 確定加密方式和金鑰
6. IPSec流程
    1. 藉由IEK和目的用戶協商SA安全協議
        1. 選擇加密方式和交換密鑰
        2. 加密策略存放於策略代理
    2. TCP/UDP後進入IPsec驅動
        1. 隧道模式
            1. 原本IP報頭和數據進行hash計算存放於IPSec報頭
            2. 新的IP報頭在IPSec報頭前以進行隧道傳輸
        2. 傳輸模式
            1. 同隧道模式計算hash放於IPSec報頭
            2. 原始IP報頭在IPSec報頭前直接以原始IP傳輸
7. 出站流程
    1. 檢查SPD安全策略數據庫確認安全策略和是否要實施IPSec
    2. 如果是, 檢查SAD安全關聯數據庫是否有存在SA安全協議
    3. 如果是, 進入IPSect處理
    4. 如果否, 執行IKE協商SA安全協議
8. 入站流程
    1. 檢查是否是受IPSec保護
    2. 如果是, 檢查SAD安全關聯數據庫是否有存在對應SPI安全參數索引和SA安全協議
    3. 如果否, 接收方也無法和發送方發起IKE
    3. 經過SA安全協議處理後, 檢查是否符合SPD安全策略數據庫的內安全策略

## IKE互聯網密鑰交換
1. IPSec 第一步會先進行IKE
2. IKE使用Oakley-ISAKMP組合進行密鑰交換
    1. Oakley: 由Photuris修改而來, 包含Cookie和身份隱藏
    2. ISAKMP: 一種空協議, 類似運載協議, 負責規定負載格式以傳送數據
3. IKE工作原理
    1. 兩個階段
        1. 設置ISAKMP: 使用Diffie–Hellman key exchange 交換主密鑰
        2. 生成IPSec SA, 並使用Oakley交換
4. 運作方式
    1. IKE庫: 包含SAD和SPD, SP由人訂定策略, 從而生成SA
    2. 經由IKE隧道(Oakley-ISAKMP)進行協商, 完成後存入雙方SAD
    3. 發送方有對應SA就可以發送給接收方
5. SA安全關聯
    1. 包含
        1. 保護類型: AH或ESP
        2. 如何進行加密和驗證
        3. 使用的密鑰
        4. 目標IP
    2. 由SPI安全參數索引管理, 儲存在SAD中
    3. 是非對稱的: A到B和B到A的需要兩個協議, 內容通常也會不一樣 
6. 示例
    1. A的SPD: 從A到B 任何協議 任何端口 策略: AH(HMAC-MD5)
    2. A的SAD: 從A到B AH協議 SPI:12 SA紀錄: 實際HMAC-MD5密鑰 

## IKE建立過程
1. 階段一
    1. 協商SA
    2. 初步密鑰交換, 使用Diffie–Hellman key exchange建立會話密鑰
    3. 認證方式
        1. 數字簽名
        2. 對方是具有預共享密鑰的MAC
    3. 有兩種模式
        1. main mode: 6輪, 提供身份認證來增加安全
            1. A給B, 階段一SA提議
            2. B給A, 階段一SA選擇
            3. A給B, A公鑰
            4. B給A, B公鑰
            5. A給B, 加密後的A身份驗證
            6. B給A, 加密後的B身份驗證
        2. active mode: 3輪
            1. A給B, SA提議, A公鑰, 未加密的A身份驗證
            2. B給A, SA選擇, B公鑰, 加密後的B身份驗證
            3. A給B, 加密後的A身份驗證
    4. main mode 會需要知道對方IP, 在不知道或是中途會NAT更改IP的情況可以使用active mode
    5. 根據這時的SA另外生成兩個密鑰用於階段二
        1. SKEYID_e: 用於加密
        2. SKEYID_a: 用於驗證
2. 階段二
    1. 全程使用階段一的密鑰加密和驗證
    2. 建立IPSec SA和新的會話密鑰
        1. A給B, 階段一的cookie, 會話標示符, IPSec SA加密提議, A的SPI, 隨機數(用於防止數據包重放), 可選流量選擇器, 可選額外密鑰
        2. B給A, 階段一的cookie, 會話標示符, IPSec SA加密選擇, B的SPI, 隨機數, 可選流量選擇器, 可選額外密鑰
        3. A給B, ack確認訊息, 可選擇使用額外密鑰加密
    3. 對於PFS完全正向保密, 可以交換額外密鑰

## IPSec兩種模式
1. 傳輸模式
    1. 終端到終端, 不會增加新的IP
    2. 終端都需要安裝IPSec
2. 隧道模式
    1. 經過路由器, 會增加新的IP報頭
    2. 可以在路由器安裝IPSec

## IPSec AH 和 ESP
1. AH認證報頭
    1. 增加報頭用作認證
    2. 提供源認證, 防止源欺騙
    3. 提供數據完整性, 使用hash
    4. 防止重放攻擊, 使用序列號
    5. 不提供保密性, 沒有進行加密
    6. 兩種模式下
        1. 傳輸模式除IP可變字段外進行hash, 認證數據放在最後
        2. 隧道模式除新的IP可變字段外進行hash, 因為原本數據包含IP會打包在AH報頭後, 認證數據放在最後
### 更多數據包詳細信息參考8:17
2. ESP封裝安全載荷
    1. 打包數據進行加密
    2. 和AH異樣提供認證和完整性
    3. 兩種模式下
        1. 傳輸模式原本數據包IP以外加密, 但是IP不會進行加密和hash
        2. 隧道模式原本數據包整個加密, 但是新IP不會進行加密和hash
### 更多數據包詳細信息參考15:08
3. ESP常用於實現VPN
    1. 使用隧道模式加密整個數據包, 以便隱藏最終目標地址
    2. 可以在ESP後再使用AH, 增強IP報頭的認證
    3. 示例
        1. A: ESP傳輸到防火牆1
        2. 防火牆1: AH隧道到防火牆2
        3. 防火牆2: 接收AH隧道後去除新IP, 發送給B, B會收到A的ESP傳輸
        4. 但是此方式原本IP並沒有進行加密
